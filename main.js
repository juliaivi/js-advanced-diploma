!function(){"use strict";class t{constructor(){this.boardSize=8,this.container=null,this.boardEl=null,this.cells=[],this.cellClickListeners=[],this.cellEnterListeners=[],this.cellLeaveListeners=[],this.newGameListeners=[],this.saveGameListeners=[],this.loadGameListeners=[]}bindToDOM(t){if(!(t instanceof HTMLElement))throw new Error("container is not HTMLElement");this.container=t}drawUi(t){this.checkBinding(),this.container.innerHTML='\n      <div class="controls">\n        <button data-id="action-restart" class="btn">New Game</button>\n        <button data-id="action-save" class="btn">Save Game</button>\n        <button data-id="action-load" class="btn">Load Game</button>\n      </div>\n      <div class="board-container">\n        <div data-id="board" class="board"></div>\n      </div>\n    ',this.newGameEl=this.container.querySelector("[data-id=action-restart]"),this.saveGameEl=this.container.querySelector("[data-id=action-save]"),this.loadGameEl=this.container.querySelector("[data-id=action-load]"),this.newGameEl.addEventListener("click",(t=>this.onNewGameClick(t))),this.saveGameEl.addEventListener("click",(t=>this.onSaveGameClick(t))),this.loadGameEl.addEventListener("click",(t=>this.onLoadGameClick(t))),this.boardEl=this.container.querySelector("[data-id=board]"),this.boardEl.classList.add(t);for(let t=0;t<this.boardSize**2;t+=1){const i=document.createElement("div");i.classList.add("cell","map-tile","map-tile-"+(e=t,a=this.boardSize,0===e?"top-left":e===a-1?"top-right":e>0&&e<a-1?"top":e===a**2-1?"bottom-right":e===a**2-a?"bottom-left":e>a**2-a&&e<a**2-1?"bottom":e%a==0?"left":(e+1)%a==0?"right":"center")),i.addEventListener("mouseenter",(t=>this.onCellEnter(t))),i.addEventListener("mouseleave",(t=>this.onCellLeave(t))),i.addEventListener("click",(t=>this.onCellClick(t))),this.boardEl.appendChild(i)}var e,a;this.cells=Array.from(this.boardEl.children)}redrawPositions(t){for(const t of this.cells)t.innerHTML="";for(const a of t){const t=this.boardEl.children[a.position],i=document.createElement("div");i.classList.add("character",a.character.type);const s=document.createElement("div");s.classList.add("health-level");const r=document.createElement("div");r.classList.add("health-level-indicator","health-level-indicator-"+((e=a.character.health)<15?"critical":e<50?"normal":"high")),r.style.width=`${a.character.health}%`,s.appendChild(r),i.appendChild(s),t.appendChild(i)}var e}addCellEnterListener(t){this.cellEnterListeners.push(t)}addCellLeaveListener(t){this.cellLeaveListeners.push(t)}addCellClickListener(t){this.cellClickListeners.push(t)}addNewGameListener(t){this.newGameListeners.push(t)}addSaveGameListener(t){this.saveGameListeners.push(t)}addLoadGameListener(t){this.loadGameListeners.push(t)}onCellEnter(t){t.preventDefault();const e=this.cells.indexOf(t.currentTarget);this.cellEnterListeners.forEach((t=>t.call(null,e)))}onCellLeave(t){t.preventDefault();const e=this.cells.indexOf(t.currentTarget);this.cellLeaveListeners.forEach((t=>t.call(null,e)))}onCellClick(t){const e=this.cells.indexOf(t.currentTarget);this.cellClickListeners.forEach((t=>t.call(null,e)))}onNewGameClick(t){t.preventDefault(),this.newGameListeners.forEach((t=>t.call(null)))}onSaveGameClick(t){t.preventDefault(),this.saveGameListeners.forEach((t=>t.call(null)))}onLoadGameClick(t){t.preventDefault(),this.loadGameListeners.forEach((t=>t.call(null)))}static showError(t){alert(t)}static showMessage(t){alert(t)}selectCell(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"yellow";this.deselectCell(t),this.cells[t].classList.add("selected",`selected-${e}`)}deselectCell(t){const e=this.cells[t];e.classList.remove(...Array.from(e.classList).filter((t=>t.startsWith("selected"))))}showCellTooltip(t,e){this.cells[e].title=t}hideCellTooltip(t){this.cells[t].title=""}showDamage(t,e){return new Promise((a=>{const i=this.cells[t],s=document.createElement("span");s.textContent=e,s.classList.add("damage"),i.appendChild(s),s.addEventListener("animationend",(()=>{i.removeChild(s),a()}))}))}setCursor(t){this.boardEl.style.cursor=t}checkBinding(){if(null===this.container)throw new Error("GamePlay not bind to DOM")}}class e{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"generic";if(this.level=t,this.attack=0,this.defence=0,this.health=50,this.type=e,"Character"===new.target.name)throw new Error("you can't create a class with type Character")}}class a extends e{constructor(t){super(t,"swordsman"),this.attack=40,this.defence=10,this.radiusMovement=4,this.radiusAttack=1}}class i extends e{constructor(t){super(t,"bowman"),this.attack=25,this.defence=25,this.radiusMovement=2,this.radiusAttack=2}}class s extends e{constructor(t){super(t,"magician"),this.attack=10,this.defence=40,this.radiusMovement=1,this.radiusAttack=4}}class r extends e{constructor(t){super(t,"daemon"),this.attack=10,this.defence=10,this.radiusMovement=1,this.radiusAttack=4}}class h extends e{constructor(t){super(t,"undead"),this.attack=40,this.defence=10,this.radiusMovement=4,this.radiusAttack=1}}class l extends e{constructor(t){super(t,"vampire"),this.attack=25,this.defence=25,this.radiusMovement=2,this.radiusAttack=2}}var c={1:"prairie",2:"desert",3:"arctic",4:"mountain"};class n{constructor(t,a){if(!(t instanceof e))throw new Error("character must be instance of Character or its children");if("number"!=typeof a)throw new Error("position must be a number");this.character=t,this.position=a}}function*o(t,e){const a=Math.floor(Math.random()*t.length),i=Math.floor(Math.random()*e+1);yield new t[a](i)}function m(t,e,a){const i=[];for(;i.length<a;){const a=o(t,e);i.push(a.next().value)}return i}var d="auto",u="pointer",C="crosshair",p="not-allowed";class v{constructor(){this.userPoints=0,this.level=1,this.activeThemes=c[this.level],this.activeTeame="player",this.numberPlayers=2,this.oldPoints=0,this.teamLocationUser=[],this.teamLocationComputer=[]}savingPoints(t){t>this.oldPoints&&(this.oldPoints=t)}}function g(t,e){const a=t%e;return[Math.floor(t/e),a]}function y(t,e,a,i){const[s,r]=g(t,a),[h,l]=g(e,a),c=4-(s-h),n=4-(r-l),o=Math.abs(s-h),m=Math.abs(r-l);return o<=i&&m<=i&&1===[[1,0,0,0,1,0,0,0,1],[0,1,0,0,1,0,0,1,0],[0,0,1,0,1,0,1,0,0],[0,0,0,1,1,1,0,0,0],[1,1,1,1,1,1,1,1,1],[0,0,0,1,1,1,0,0,0],[0,0,1,0,1,0,1,0,0],[0,1,0,0,1,0,0,1,0],[1,0,0,0,1,0,0,0,1]][c][n]?1:0}function L(t,e,a,i){const[s,r]=g(t,a),[h,l]=g(e,a),c=Math.abs(s-h),n=Math.abs(r-l);return c<=i&&n<=i}const f=new t;f.bindToDOM(document.querySelector("#game-container"));const P=new class{constructor(t){this.storage=t}save(t){this.storage.setItem("state",JSON.stringify(t))}load(){try{return JSON.parse(this.storage.getItem("state"))}catch(t){throw new Error("Invalid state")}}}(localStorage),S=new class{constructor(t,e){this.gamePlay=t,this.stateService=e,this.userTypes=[i,a,s],this.computerTypes=[l,r,h],this.characterTypeUser=["bowman","swordsman","magician"],this.level=1,this.teamLocationUser=[],this.activeCharacte=null,this.activeCharacteComputer=null,this.activeCell=null,this.number=null,this.clickCharterComputer=null,this.step=null,this.teamUser=[],this.teamComputer=[],this.teamLocationUser=[],this.teamLocationComputer=[],this.charactersPositions=[]}init(){this.newGame(),this.gamePlay.addCellEnterListener(this.onCellEnter.bind(this)),this.gamePlay.addCellLeaveListener(this.onCellLeave.bind(this)),this.gamePlay.addCellClickListener(this.onCellClick.bind(this)),this.gamePlay.addNewGameListener(this.newGame.bind(this)),this.gamePlay.addSaveGameListener(this.saveGame.bind(this)),this.gamePlay.addLoadGameListener(this.loadGame.bind(this))}newGame(){this.getAttack=!1,this.gameStop=!1,this.gameState=new v,this.level=1,this.gamePlay.drawUi(c[this.level]);const t=m(this.userTypes,this.level,2),e=m(this.computerTypes,this.level,2);this.teamLocationUser=this.locationTeams(t),this.teamLocationComputer=this.locationTeams(e),this.allCharactersOnField=[...this.teamLocationUser,...this.teamLocationComputer],this.charactersPositions=this.allCharactersOnField.map((t=>t.position)),this.gamePlay.redrawPositions(this.allCharactersOnField),this.gameState.activeThemes=c[this.level],this.gameState.teamLocationUser=this.teamLocationUser,this.gameState.teamLocationComputer=this.teamLocationComputer,this.gameState.level=this.level,this.gameState.activeTeame="player"}positionUser(t){const e=Math.round(Math.random()*t);return this.gamePlay.boardSize*(e%this.gamePlay.boardSize)+Math.floor(e/this.gamePlay.boardSize)}positionComputer(t){const e=Math.round(Math.random()*t);return this.gamePlay.boardSize*(e%this.gamePlay.boardSize)+Math.ceil(this.gamePlay.boardSize-1-e/this.gamePlay.boardSize)}locationTeams(t){const e=[],a=[];let i;do{for(const s of t){if(i=this.characterTypeUser.includes(s.type)?this.positionUser(2*this.gamePlay.boardSize-1):this.positionComputer(2*this.gamePlay.boardSize-1),a.includes(i))break;a.push(i),e.push(new n(s,i))}}while(t.length!==e.length);return e}onCellClick(e){if(this.gameStop)return this.gamePlay.setCursor("auto"),void this.gamePlay.deselectCell(e);const a=this.allCharactersOnField.find((t=>t.position===e));!a||this.characterTypeUser.includes(a.character.type)||this.activeCharacte?(a&&null!==this.activeCharacte&&this.activeCharacte.position!==a.position&&this.characterTypeUser.includes(a.character.type)&&this.gamePlay.deselectCell(this.activeCharacte.position),a&&(this.characterTypeUser.includes(a.character.type)?(this.activeCharacteComputer=null,this.activeCharacte=a,this.gamePlay.selectCell(e)):this.clickCharterComputer=a),this.activeCharacte&&!this.allCharactersOnField.find((t=>t.position===e))&&this.takeStepUser(e),this.activeCharacte&&null!==this.clickCharterComputer&&!0===this.getAttack&&this.attackUser(e,a)):t.showError("Вы не можите выбрать данного персонажа. Это персонаж противника!")}onCellEnter(t){const e=this.allCharactersOnField.find((e=>e.position===t));if(this.gameStop)return this.gamePlay.setCursor("auto"),void this.gamePlay.deselectCell(t);e&&this.allCharactersOnField.find((e=>e.position===t))&&this.showInfo(e,t),e&&this.characterTypeUser.includes(e.character.type)?this.gamePlay.setCursor(u):null!==this.activeCharacte?null!==this.activeCharacte&&e?this.displayAttack(t,e):this.displayStep(t):this.gamePlay.setCursor(d)}showInfo(t,e){const a=`🎖${t.character.level}⚔${t.character.attack}🛡${t.character.defence}❤${t.character.health}`;this.gamePlay.showCellTooltip(a,e)}displayAttack(t,e){null===this.activeCharacte||null===this.activeCharacteComputer||this.characterTypeUser.includes(e.character.type)||this.gamePlay.deselectCell(this.activeCharacteComputer.position),null!==this.activeCell&&this.activeCell!==t&&this.activeCharacteComputer!==t&&this.gamePlay.deselectCell(this.activeCell),this.activeCell=t;const a=this.activeCharacte.character.radiusAttack;null!==this.activeCharacte&&(this.activeCharacteComputer=e),this.getAttack=L(this.activeCharacte.position,this.activeCell,this.gamePlay.boardSize,a),!0===this.getAttack&&this.activeCharacte.position!==this.activeCell?(this.gamePlay.deselectCell(this.activeCell),this.gamePlay.selectCell(t,"red"),this.gamePlay.setCursor(C),this.activeCharacteComputer=null):(this.gamePlay.setCursor(p),this.activeCharacteComputer=null)}displayStep(t){if(null!==this.activeCharacte&&null===this.activeCharacteComputer&&this.allCharactersOnField.find((e=>e.position!==t))&&(this.step=this.activeCharacte.character.radiusMovement),null!==this.activeCell&&this.activeCell!==t&&this.activeCharacte.position!==this.activeCell&&this.gamePlay.deselectCell(this.activeCell),this.activeCell=t,this.number=y(this.activeCharacte.position,this.activeCell,this.gamePlay.boardSize,this.step),1===this.number)this.gamePlay.setCursor(u),this.gamePlay.selectCell(t,"green");else if(0===this.number)return void this.gamePlay.setCursor(p);this.gamePlay.setCursor(d)}onCellLeave(t){if(this.gameStop)return this.gamePlay.setCursor("auto"),void this.gamePlay.deselectCell(t);this.allCharactersOnField.find((e=>e.position===t))&&this.gamePlay.hideCellTooltip(t)}takeStepUser(t){null!==this.number&&1===this.number?(this.gamePlay.deselectCell(this.activeCharacte.position),this.activeCharacte.position=t,this.gamePlay.deselectCell(t),this.activeCharacte=null,this.clickCharterComputer=null,this.number=null,this.gameState.teamLocationComputer=this.teamLocationComputer,this.gameState.teamLocationUser=this.teamLocationUser,this.gamePlay.redrawPositions(this.allCharactersOnField),this.gameState.activeTeame="enemy","enemy"===this.gameState.activeTeame&&this.teamLocationComputer.length>0&&this.attackEnemy()):this.gamePlay.setCursor(p)}attackUser(t){const e=Number(Math.max(this.activeCharacte.character.attack-this.clickCharterComputer.character.defence,.1*this.activeCharacte.character.attack).toFixed(1));(async()=>{await this.gamePlay.showDamage(t,e);const a=this.clickCharterComputer.character.health-e;this.clickCharterComputer.character.health=a,this.clickCharterComputer.character.health<=0&&this.deletingСharacter(this.teamLocationComputer,this.clickCharterComputer.position),this.gamePlay.deselectCell(this.activeCell),this.gamePlay.deselectCell(this.activeCharacte.position),this.getAttack=!1,this.activeCharacte=null,this.clickCharterComputer=null,this.activeCharacteComputer=null,this.teamLocationComputer.length>0&&(this.gameState.teamLocationComputer=this.teamLocationComputer,this.gameState.teamLocationUser=this.teamLocationUser,this.gamePlay.redrawPositions(this.allCharactersOnField),this.gameState.activeTeame="enemy",this.attackEnemy()),0===this.teamLocationComputer.length&&this.levelUp()})(),this.activeCharacte&&null===this.clickCharterComputer&&(this.getAttack=!1)}"deletingСharacter"(t,e){const a=t.findIndex((t=>t.position===e));t.splice(a,1),this.allCharactersOnField=[...this.teamLocationUser,...this.teamLocationComputer],this.gameState.allCharactersOnField=this.allCharactersOnField,this.gameState.teamLocationComputer=this.teamLocationComputer,this.gameState.teamLocationUser=this.teamLocationUser,this.gamePlay.redrawPositions(this.allCharactersOnField)}attackEnemy(){if(this.randomIndex=Math.floor(Math.random()*this.teamLocationComputer.length),this.enemyСharacter=this.teamLocationComputer[this.randomIndex].character,this.enemyPosition=this.teamLocationComputer[this.randomIndex].position,this.getAttack=!1,this.searchUserСharacter(this.teamLocationUser,this.enemyСharacter),!0===this.getAttack){const t=Number(Math.max(this.enemyСharacter.attack-this.firstСharacterUser.defence,.1*this.enemyСharacter.attack).toFixed(1));(async()=>{await this.gamePlay.showDamage(this.positionСharacterUser,t);const e=this.firstСharacterUser.health-t;this.firstСharacterUser.health=e,this.firstСharacterUser.health>0?this.gameState.activeTeame="user":(this.deletingСharacter(this.teamLocationUser,this.positionСharacterUser),0!==this.teamLocationUser.length?this.gameState.activeTeame="user":(this.gameStop=!0,alert("Game over!")))})()}!1===this.getAttack&&this.takeStepEnemy(),this.getAttack=!1}"searchUserСharacter"(t,e){const a=e.radiusAttack;for(const e of t)if(this.firstСharacterUser=e.character,this.positionСharacterUser=e.position,!0===L(this.enemyPosition,this.positionСharacterUser,this.gamePlay.boardSize,a)){this.getAttack=!0;break}}takeStepEnemy(){let t;const e=this.enemyСharacter.radiusMovement;do{this.randomIndexPosition=Math.floor(Math.random()*(this.gamePlay.boardSize*this.gamePlay.boardSize-1)),this.allCharactersOnField.find((t=>t.position===this.randomIndexPosition))||(t=y(this.enemyPosition,this.randomIndexPosition,this.gamePlay.boardSize,e))}while(1!==t);this.enemyPosition=this.randomIndexPosition,this.teamLocationComputer[this.randomIndex].position=this.randomIndexPosition,this.gameState.teamLocationComputer=this.teamLocationComputer,this.gameState.teamLocationUser=this.teamLocationUser,this.gamePlay.redrawPositions(this.allCharactersOnField),this.number=null,this.gameState.activeTeame="user"}levelUp(){this.remainingСharacters=[],this.newTeamUser=[],this.newElement=[],this.level>4&&(this.gameStop=!0),this.level+=1,this.gameState.numberPlayers<6?this.gameState.numberPlayers+=1:this.gameState.numberPlayers=6;const t=this.gameState.numberPlayers-this.teamLocationUser.length;t<this.gameState.numberPlayers&&(this.newTeamUser=m(this.userTypes,this.gameState.level,t)),this.transferСharacteristics(),this.teamUser=[...this.remainingСharacters,...this.newTeamUser],this.teamComputer=m(this.computerTypes,this.gameState.level,this.gameState.numberPlayers),this.teamLocationUser=this.locationTeams(this.teamUser),this.teamLocationComputer=this.locationTeams(this.teamComputer),this.gameState.userPoints+=1,this.gameState.level+=1,this.gameState.savingPoints(this.gameState.userPoints),this.allCharactersOnField=[...this.teamLocationUser,...this.teamLocationComputer],this.performanceEnhancement(),this.gameState.activeTeame="user",this.gamePlay.drawUi(c[this.level]),this.gamePlay.redrawPositions(this.allCharactersOnField),this.gameStop=!1}"transferСharacteristics"(){this.teamLocationUser.forEach((t=>{if(this.userTypes.includes(t.character))this.remainingСharacters.push(t.character);else{const{type:e,level:a,attack:i,defence:s,health:r,radiusMovement:h,radiusAttack:l}=t.character;do{this.newElement=m(this.userTypes,this.gameState.level,1)}while(this.newElement[0].type!==e);this.newElement[0].level=a,this.newElement[0].attack=i,this.newElement[0].defence=s,this.newElement[0].health=r,this.newElement[0].radiusMovement=h,this.newElement[0].radiusAttack=l,this.remainingСharacters.push(...this.newElement)}}))}performanceEnhancement(){for(const t of this.allCharactersOnField)t.character.attack=Math.floor(Math.max(t.character.attack,t.character.attack*(80+t.character.health)/100)),t.character.defence=Math.floor(Math.max(t.character.defence,t.character.defence*(80+t.character.health)/100)),t.character.health=t.character.health+80>=100?100:t.character.health+80}saveGame(){this.stateService.save(this.gameState)}loadGame(){this.gameStop=!1;const t=this.stateService.load();this.gameState.userPoints=t.userPoints,this.teamLocationUser=t.teamLocationUser,this.teamLocationComputer=t.teamLocationComputer,this.allCharactersOnField=[...this.teamLocationUser,...this.teamLocationComputer],this.level=t.level,this.activeTeame=t.activeTeame,this.gamePlay.drawUi(t.activeThemes),this.gamePlay.redrawPositions(this.allCharactersOnField)}}(f,P);S.init()}();